#!/usr/bin/env python

import base64
import os
import json
import sys

environment = sys.argv[1]
environment = environment.upper()

# Only grab the variables that are pertinent to the environment.
data = {
    "{}_VERSION".format(environment): os.environ.get('CIRCLE_SHA1')
}
env_file = []

for env, val in os.environ.items():
    prefix = environment
    if env.startswith(prefix):
        env_without_prefix = env[len(prefix)+1:]

        data[env_without_prefix] = base64.b64encode(bytes(val, 'utf-8')).decode()
        env_file += ["export {}={}".format(env_without_prefix, val)]

data["environment-file"] = base64.b64encode(bytes("\n".join(env_file), 'utf-8')).decode()

json_output = {
    "apiVersion": "v1",
    "kind": "Secret",
    "metadata": {
        "name": "<%= secrets_name %>"
    },
    "type": "Opaque",
    "data": data,
}

print(json.dumps(json_output))
